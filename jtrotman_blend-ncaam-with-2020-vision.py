# Auto-generated, do not edit!

# One final run.

INIT = [('artgor/march-madness-2020-ncaam-eda-and-baseline',

  'march-madness-2020-ncaam-eda-and-baseline',

  7982339,

  'March Madness 2020 NCAAM EDA and baseline',

  '2020-03-05T09:29:41.637Z',

  'Andrew Lukyanenko',

  'artgor',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/727004-gr.jpg',

  0.38446,

  90,

  'ðŸ¥‡'),

 ('ratan123/march-madness-2020-ncaam-simple-lightgbm-on-kfold',

  'march-madness-2020-ncaam-simple-lightgbm-on-kfold',

  7985375,

  'March Madness 2020 NCAAM:Simple Lightgbm on KFold',

  '2020-03-06T15:31:46.44Z',

  'ratan rohith',

  'ratan123',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1649622-kg.png',

  0.14907,

  68,

  'ðŸ¥‡'),

 ('vbmokin/mm-ncaam-no-leaks-lgb-xgb-logreg',

  'mm-ncaam-no-leaks-lgb-xgb-logreg',

  8053294,

  'MM NCAAM [No leaks]: LGB, XGB, LogReg',

  '2020-03-13T13:14:34.803Z',

  'Vitalii Mokin',

  'vbmokin',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1798416-gp.jpg',

  0.04872,

  63,

  'ðŸ¥ˆ'),

 ('khoongweihao/ncaam2020-xgboost-lightgbm-k-fold-baseline',

  'ncaam2020-xgboost-lightgbm-k-fold-baseline',

  7990667,

  'NCAAM2020: XGBoost + LightGBM K-Fold (Baseline)',

  '2020-02-25T05:01:27.193Z',

  'Wei Hao Khoong',

  'khoongweihao',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1738095-kg.png',

  0.03966,

  44,

  'ðŸ¥ˆ'),

 ('hiromoon166/2020-basic-starter-kernel',

  '2020-basic-starter-kernel',

  7979510,

  '2020 Basic Starter Kernel',

  '2020-02-15T09:17:12.803Z',

  'hiromu',

  'hiromoon166',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1497263-kg.jpg',

  0.54999,

  35,

  'ðŸ¥ˆ'),

 ('latimerb/2020-model-comparison-no-leak-submission',

  '2020-model-comparison-no-leak-submission',

  8034043,

  '2020 Model Comparison + No leak submission',

  '2020-02-24T19:34:47.517Z',

  'BenLatimer',

  'latimerb',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1265370-fb.jpg',

  0.47433,

  21,

  'ðŸ¥‰'),

 ('nxrprime/march-madness-2020-ncaam-simple-lightgbm-on-kfold',

  'march-madness-2020-ncaam-simple-lightgbm-on-kfold',

  7990996,

  'March Madness 2020 NCAAM:Simple Lightgbm on KFold',

  '2020-02-16T04:58:19.02Z',

  'Pentagram',

  'nxrprime',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/4321234-kg.jpg',

  0.35928,

  12,

  'ðŸ¥‰'),

 ('takaishikawa/no-ml-modeling-ncaam2020',

  'no-ml-modeling-ncaam2020',

  8100893,

  'No ML Modeling - NCAAM2020',

  '2020-02-24T02:39:18.213Z',

  'Tak',

  'takaishikawa',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1015481-kg.jpg',

  0.56364,

  11,

  'ðŸ¥‰'),

 ('miklgr500/keras-nn',

  'keras-nn',

  8009038,

  'Keras NN',

  '2020-02-23T12:01:38.517Z',

  'Michael Kazachok',

  'miklgr500',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1210896-kg.jpg',

  0.47433,

  11,

  'ðŸ¥‰'),

 ('chariots17/predicting-with-dnn-xgboost-tensorflow',

  'predicting-with-dnn-xgboost-tensorflow',

  7994061,

  'Predicting with DNN&XGboost(Tensorflow)',

  '2020-02-22T03:49:04.807Z',

  'è°ä¸é‡è¦',

  'chariots17',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/2519363-kg.jpg',

  0.35718,

  11,

  'ðŸ¥‰'),

 ('code1110/ncaam20-finally-no-leak-starter',

  'ncaam20-finally-no-leak-starter',

  8085813,

  '[NCAAM20] (finally) no-leak starter',

  '2020-02-29T09:57:51.853Z',

  'katsu1110',

  'code1110',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/590240-fb.jpg',

  0.55398,

  9,

  'ðŸ¥‰'),

 ('kmatsuyama/to-avoid-overfitting-ensemble-with-trueskill',

  'to-avoid-overfitting-ensemble-with-trueskill',

  8179034,

  'To avoid overfitting: ensemble with TrueSkill ',

  '2020-03-07T02:39:41.377Z',

  'kmatsuyama',

  'kmatsuyama',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/3526234-kg.png',

  0.3763,

  8,

  'ðŸ¥‰'),

 ('ash16win/march-madness-ensemble-h2o-xgboost-and-gbm',

  'march-madness-ensemble-h2o-xgboost-and-gbm',

  8158539,

  'March Madness Ensemble H2o-XGBoost and GBM',

  '2020-02-28T20:32:44.443Z',

  'ash16win',

  'ash16win',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/default-thumb.png',

  0.01676,

  7,

  'ðŸ¥‰'),

 ('christoffer/simple-k-optimized-elo-model',

  'simple-k-optimized-elo-model',

  8166252,

  'Simple k-optimized Elo model',

  '2020-02-27T14:52:52.227Z',

  'Christoffer Karlsson',

  'christoffer',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/94532-kg.png',

  0.60263,

  6,

  'ðŸ¥‰'),

 ('tovvelie/simple-seed-based-model',

  'simple-seed-based-model',

  8071879,

  'Simple seed based model',

  '2020-02-24T10:59:59.62Z',

  'Artem Rumyantsev',

  'tovvelie',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/default-thumb.png',

  0.59323,

  5,

  ' '),

 ('santohide/my-first-gbdt',

  'my-first-gbdt',

  8187632,

  'My first GBDT ',

  '2020-03-11T12:24:14.853Z',

  'santo',

  'santohide',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/default-thumb.png',

  0.43304,

  5,

  ' '),

 ('domoldo/ncaa-logistic-regression-example-gmu-kaggle-club',

  'ncaa-logistic-regression-example-gmu-kaggle-club',

  8181864,

  'NCAA Logistic Regression example (GMU Kaggle Club)',

  '2020-02-29T18:37:15.41Z',

  'Dominic White',

  'domoldo',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/31963-kg.jpg',

  0.55256,

  4,

  ' '),

 ('code1110/ncaam20-eda-and-nn-lgb-catb-starter',

  'ncaam20-eda-and-nn-lgb-catb-starter',

  7993081,

  '[NCAAM20] EDA and NN+LGB+CatB starter',

  '2020-02-21T13:17:40.517Z',

  'katsu1110',

  'code1110',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/590240-fb.jpg',

  0.32227,

  4,

  ' '),

 ('tenffe/autogluon-for-basic-data-process',

  'autogluon-for-basic-data-process',

  7983412,

  'autogluon_for_basic_data_process',

  '2020-02-16T08:49:24.887Z',

  'zhangxin',

  'tenffe',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1536982-kg.jpg',

  0.52281,

  4,

  ' '),

 ('jollibobert/ncaam2020-logistic-regression-baseline-cv-0-55',

  'ncaam2020-logistic-regression-baseline-cv-0-55',

  8121881,

  'NCAAM2020 - Logistic Regression Baseline [CV 0.55]',

  '2020-02-26T14:24:26.727Z',

  'Robert Tacbad',

  'jollibobert',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/749307-kg.jpg',

  0.54935,

  3,

  ' '),

 ('ben519/professor-data-cleaning-and-modeling',

  'professor-data-cleaning-and-modeling',

  8356503,

  'Professor: Data cleaning and modeling',

  '2020-03-12T15:23:28.177Z',

  'Ben Gorman',

  'ben519',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/112010-kg.jpg',

  0.53676,

  2,

  ' '),

 ('adarshsng/march-madness-2020-ncaam-simple-dnn-with-sk-fold',

  'march-madness-2020-ncaam-simple-dnn-with-sk-fold',

  8292317,

  'March Madness 2020 NCAAM: Simple DNN with SK-Fold',

  '2020-03-07T18:33:39.06Z',

  'xdarshsingh',

  'adarshsng',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/3974712-kg.jpeg',

  0.54324,

  2,

  ' '),

 ('lorenzodenisi/ncaam-prediction-with-overall-rankings-and-dnn',

  'ncaam-prediction-with-overall-rankings-and-dnn',

  8221058,

  'NCAAM prediction with overall rankings and DNN',

  '2020-03-02T18:41:33.233Z',

  'Lorenzo De Nisi',

  'lorenzodenisi',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/3695984-kg.png',

  0.54715,

  2,

  ' '),

 ('scirpus/mother-of-all-gp',

  'mother-of-all-gp',

  8165286,

  'Mother of all GP',

  '2020-02-27T13:50:42.033Z',

  'Scirpus',

  'scirpus',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/241438-fb.jpg',

  0.52124,

  2,

  ' '),

 ('scirpus/complex-secret-sauce',

  'complex-secret-sauce',

  8164177,

  'Complex Secret Sauce?',

  '2020-02-27T12:18:21.367Z',

  'Scirpus',

  'scirpus',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/241438-fb.jpg',

  0.51832,

  2,

  ' '),

 ('scirpus/secret-sauce',

  'secret-sauce',

  8162934,

  'Secret Sauce?',

  '2020-02-27T10:55:06.26Z',

  'Scirpus',

  'scirpus',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/241438-fb.jpg',

  0.52299,

  2,

  ' '),

 ('jarnel/clipping-spline-experiment-on-test-predictions',

  'clipping-spline-experiment-on-test-predictions',

  8067852,

  'Clipping/Spline Experiment on test predictions',

  '2020-02-21T00:00:24.07Z',

  'jarnel',

  'jarnel',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/default-thumb.png',

  0.30627,

  2,

  ' '),

 ('ricardo13/ncaam2020-baseline-with-xgb-lgb-blending',

  'ncaam2020-baseline-with-xgb-lgb-blending',

  7990151,

  'NCAAM2020-baseline with XGB&LGB Blending',

  '2020-02-16T01:56:32.217Z',

  'Ricardo Lee',

  'ricardo13',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1110110-kg.jpg',

  0.43584,

  2,

  ' '),

 ('omarrodriguez/seed-only-model',

  'seed-only-model',

  8355729,

  'Seed-only model',

  '2020-03-11T19:09:13Z',

  'Omar',

  'omarrodriguez',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/default-thumb.png',

  0.55006,

  1,

  ' '),

 ('bsherman10/ncaa-march-madness-2020',

  'ncaa-march-madness-2020',

  8210356,

  'NCAA March Madness 2020',

  '2020-03-10T04:09:34.577Z',

  'Brad Sherman',

  'bsherman10',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1677587-gp.jpg',

  0.51876,

  1,

  ' '),

 ('nickteim/google-cloud-simple-model',

  'google-cloud-simple-model',

  8326241,

  'Google cloud simple model ',

  '2020-03-09T23:42:36.14Z',

  'NickTeim',

  'nickteim',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/3766931-kg.PNG',

  0.51801,

  1,

  ' '),

 ('miklgr500/bayesian-neural-network-in-keras-ncaam',

  'bayesian-neural-network-in-keras-ncaam',

  8303223,

  'Bayesian Neural Network in Keras NCAAM',

  '2020-03-09T11:20:58.957Z',

  'Michael Kazachok',

  'miklgr500',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1210896-kg.jpg',

  0.59552,

  1,

  ' '),

 ('tnmasui/ncaam-2020-lgb-w-fe-on-three-datasets',

  'ncaam-2020-lgb-w-fe-on-three-datasets',

  8210334,

  'NCAAM 2020 - LGB w/ FE on three Datasets',

  '2020-03-02T01:59:12.927Z',

  'Tomonori Masui',

  'tnmasui',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/427399-kg.JPG',

  0.51968,

  1,

  ' '),

 ('scirpus/not-another-genetic-program',

  'not-another-genetic-program',

  8132612,

  'Not another Genetic Program',

  '2020-02-25T12:22:54.883Z',

  'Scirpus',

  'scirpus',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/241438-fb.jpg',

  0.61137,

  1,

  ' '),

 ('jmaslek/mens-tourney-highest-seed-baseline',

  'mens-tourney-highest-seed-baseline',

  8062442,

  'Mens Tourney - Highest Seed Baseline',

  '2020-02-20T16:01:18.873Z',

  'GoSabres',

  'jmaslek',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1716008-gp.jpg',

  9.44076,

  1,

  ' '),

 ('grapestone5321/ml-competition-2020-ncaam-sample-submission',

  'ml-competition-2020-ncaam-sample-submission',

  8340156,

  ' ML Competition 2020-NCAAM-sample_submission',

  '2020-03-10T18:10:38.953Z',

  'Naruhiko Nakanishi',

  'grapestone5321',

  'https://storage.googleapis.com/kaggle-avatars/thumbnails/1107630-kg.jpg',

  0.69314,

  0,

  ' ')]


import pandas as pd

import numpy as np

import os, re, sys

import matplotlib.pyplot as plt

from IPython.core.display import HTML, Image



TAG = 'NCAAM_2020'

DIR  = '../input/google-cloud-ncaa-march-madness-2020-division-1-mens-tournament/MDataFiles_Stage1'

PNG_DIR = '/kaggle/plots'

OUTPUT_ZIP = f'{TAG}_stage1_plots.zip'



os.makedirs(PNG_DIR, exist_ok=True)



def read_results():

    res = pd.read_csv(f'{DIR}/MNCAATourneyCompactResults.csv').query('DayNum>=136')

    TC = ['WTeamID', 'LTeamID']

    res['Low'] = res[TC].min(1)

    res['High'] = res[TC].max(1)

    res['Truth'] = res.eval('Low==WTeamID').astype(int)

    res['Key'] = res.apply(lambda r: f'{r.Season}_{r.Low}_{r.High}', 1)

    res = res.set_index('Key')

    return res



TEAMS = pd.read_csv(f'{DIR}/MTeams.csv', index_col=0)

SEEDS = pd.read_csv(f'{DIR}/MNCAATourneySeeds.csv', index_col=2)

RESULTS = read_results()



TEAMS.shape, SEEDS.shape, RESULTS.shape
plt.rc('figure', figsize=(14, 14))

plt.rc('font', size=12)



ICOLS = ['i1', 'i2']





def expand_sub(df):

    parts = df['id'].str.split('_')

    df['year'] = parts.str[0].astype(int)

    df['t1'] = parts.str[1].astype(int)

    df['t2'] = parts.str[2].astype(int)

    return df[['id', 'year', 't1', 't2', 'pred']].set_index('id')





# return a submission in a standard form

def read_sub(name):

    df = pd.read_csv(name)

    df.columns = df.columns.str.lower()

    return expand_sub(df)





def log_loss(df):

    p = np.where(df.Truth, df.pred, 1 - df.pred)

    # clip low predictions to avoid infinite loss

    p = p.clip(min=1e-15)

    return (-np.log(p)).mean()





def score_sub(sub):

    df = sub.join(RESULTS, how='inner')

    return log_loss(df)





class Year:



    def __init__(self, res, seeds):

        self.res = res

        ids = set(res.Low) | set(res.High)

        self.nteams = len(ids)

        self.seeds = seeds[seeds.index.isin(ids)] # 64 teams

        self.seeds = self.seeds.join(TEAMS)

        self.inds = dict(zip(self.seeds.index, range(self.nteams)))

        # labels for each axis

        self.seeds['lx'] = self.seeds.Seed + " " + self.seeds.TeamName

        self.seeds['ly'] = self.seeds.TeamName + " " + self.seeds.Seed

    

    def add_inds(self, df):

        df = df.assign(i1=df.t1.map(self.inds), i2=df.t2.map(self.inds))

        df = df.dropna()

        df[ICOLS] = df[ICOLS].astype(int)

        return df



    def to_matrix(self, sub):

        sub = self.add_inds(sub)

        nteams = self.nteams

        m = np.ones((nteams, nteams)) * 0.5

        m[sub.i1, sub.i2] = sub.pred

        m[sub.i2, sub.i1] = 1 - sub.pred

        return m



    def heatmap(self, sub, filename, cmap=plt.cm.seismic):

        probs = self.to_matrix(sub)

        fig, ax = plt.subplots()

        heatmap = ax.pcolormesh(probs, vmin=0., vmax=1., cmap=cmap)



        ax.spines['top'].set_visible(False)

        ax.spines['right'].set_visible(False)

        ax.spines['bottom'].set_visible(False)

        ax.spines['left'].set_visible(False)



        ax.invert_yaxis()

        ax.tick_params(direction='out')

        ax.xaxis.tick_top()

        ax.yaxis.tick_left()

        plt.xticks(rotation=90)



        # put the major ticks at the middle of each cell

        ax.set_xticks(np.arange(self.nteams)+0.5, minor=False)

        ax.set_yticks(np.arange(self.nteams)+0.5, minor=False)

        ax.set_xticklabels(self.seeds['lx'])

        ax.set_yticklabels(self.seeds['ly'])

        plt.savefig(filename, bbox_inches='tight')   





YLIST = SEEDS.Season.unique()

YEARS = { year: Year(RESULTS.query(f'Season=={year}'), SEEDS.query(f'Season=={year}')) for year in YLIST }
def reader(lst):

    for scriptUrl, currentUrlSlug, *rest in lst:

        bd = f'../input/{currentUrlSlug}'

        subs = {}

        try:

            files = os.listdir(bd)

            for f in files:

                if f.lower().endswith('.csv'):

                    try:

                        sub = read_sub(f'{bd}/{f}')

                        subs[f] = sub

                    except:

                        pass

        except:

            pass

        if len(subs) > 0:

            yield [scriptUrl, currentUrlSlug] + rest + [subs]



# Ensemble average

sums = 0

count = 0



def show_years(sub, tag):

    display(HTML(

        f'<h2>Prediction Stats</h2>'

        f'<p>Log Loss: {score_sub(sub):.6f}'

    ))

    gb = sub.groupby('year')

    display(gb.pred.agg(['count', 'min', 'max']))

    for year, subdf in gb:

        display(HTML(

            f'<h2>{year}</h2>'

            f'<p>Log Loss: {score_sub(subdf):.6f}'

        ))

        YEARS[year].heatmap(subdf, f'{PNG_DIR}/{tag}_{year}')

        plt.show()



for scriptUrl, currentUrlSlug, _id, title, lastRunTime, displayName, userName, thumbnailUrl, bestPublicScore, totalVotes, medal, subs in reader(INIT):

    display(HTML(

        f'<h1 id="{currentUrlSlug}">{title}</h1>'

        f'<table><tr><td style="vertical-align:top"><img src="{thumbnailUrl}"></td>'

        f'<td style="vertical-align:top"><p><b>{displayName}</b>'

        f'<p><a href="https://www.kaggle.com/{scriptUrl}">{scriptUrl}</a>'

        f'<br>Last run: {pd.to_datetime(lastRunTime).strftime("%c")} '

        f'<br>Votes: {totalVotes} {medal}'

        f'<br>Best public log-loss: {bestPublicScore} '

        f'</td></tr></table>'

    ))

    

    for csv, sub in subs.items():

        show_years(sub, f'{userName}_{currentUrlSlug}')



        sums += sub[['pred']].clip(0, 1)

        count += 1
ensemble = (sums / count)

count, score_sub(ensemble)
show_years(expand_sub(ensemble.reset_index()), f'{TAG}_ensemble')
ensemble.to_csv(f'{TAG}_blend.csv')
!7z a -bd -mmt4 {OUTPUT_ZIP} {PNG_DIR}/*.png
!find /kaggle > file_list.txt